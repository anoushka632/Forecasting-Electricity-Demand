---
title: "Forecasting UK Electricity Demand"
author: "Anoushka Ghosh"
date: '2022-05-29'
output: pdf_document
---



```{r}
##loading the libraries needed
library(dplyr)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(corrplot)
library(lubridate)
library(xts)
library(mgcv)
library(visreg)
library(Metrics)

```



```{r}
##loading the data
load("UKL.RDa")
ukdata <- data.frame(UKL)

##view the head
head(ukdata)
```

```{r}

dim(ukdata) ## ~90400 observations and 15 variables

##see structure of data
str(ukdata)

```
Notes:
1. Month and year is int; should change to factor
2.Sun=1,Sat=7


```{r}
##check for missing values
sum(is.na(ukdata)) ##no missing values

##summarize the data
summary(ukdata)

```



```{r}

##Data Pre-Processing
## We make some new variables here, 
##the first one is just the data variable without the time named onlydate
##the second and third ones are one and two day lagged temperatures, lagtemp48 & lagtemp96
##(since we have half-hourly data, 1 day= 48 x 1, 2 day = 48 x 2)
##the fourth one is the one week (7 day) lagged demand

ukdata <- ukdata %>%
  mutate(onlydate = as.Date(ymd_hms(date)), ##only date without time
         lagtemp48 = lag(temp,order_by = onlydate,48), ## one-day lagged temperature
         lagtemp96 = lag(temp,order_by = onlydate,96), ##two-day lagged temperature
         load336 = lag(load,order_by = onlydate,336) ##one week lagged load
         )

```



## Examining the electricity load 

```{r}
##boxplot for the load
boxplot(ukdata$load,xlab = "Grid Load", ylab = 'Grid Load (MW)', main="Boxplot for Grid Load ")
```
```{r}
##distribution of load 
p1 <- ggplot(ukdata, aes(load)) + 
              geom_histogram(bins = 50, col = "red",
                            fill = "red",alpha = 0.3) +
              geom_density(alpha = 0.1) +
              ggtitle("Histogram (Density plot) of Grid Load")
  

p1
```

```{r}
## Check correlations between variables

# get the correlation matrix
cormat <- ukdata %>%
  select_if(is.numeric) %>%
  {round(cor(.),2)}

#plot the correlations
corrplot(cormat,method="number")

```
Note:
1. Correlations between the calender effects, which is expected.
2. Correlations between the weather predictors, again expected.Both are Auto-correlations.


## Data Train-Validation Split

```{r}
##split the data into training and validation set
train   =  subset(ukdata, year <= 2015 )
validation =  subset(ukdata, year == 2016)

```


## Data Exploration on the Training set

```{r}
##load v/s time
load.df <- train %>%
  group_by(onlydate) %>%
  summarise(mean_load = mean(load))

gg1 <- ggplot(load.df, aes(onlydate, mean_load))+
  geom_line()+
  xlab("Time")+
  ylab(" Electricity Demand (MW)")+
  theme(aspect.ratio=1/5) +
  ggtitle("")

gg1
```

```{r}
# Demand by day of the week
ggplot(train, aes(dow, load)) +
  geom_boxplot() + xlab('Day') + 
  ylab('Demand (MW)')+ylim(15000,60000) + 
  ggtitle('Demand per day of the week')
```

```{r}
# Demand by time of the day
options(repr.P.width=8,repr.P.height=4)
ggplot(train, aes(as.factor(tod), load)) +
  geom_boxplot() + 
  xlab('Time of day') +
  ylab('Demand (MW)')+
  ylim(15000,60000) + 
  ggtitle('Demand by the time of the day')

```

```{r}

##avg electricity demand v/s month
avg_demand_month <- aggregate(load ~ month, train, 'mean')

ggplot(avg_demand_month, aes(month, load))+
  geom_line()+
  xlab("Month")+
  ylab(" Average Monthly Load (MW)")+
  theme(aspect.ratio=1/5)
  
```
Notes: 
1. Demand is high during the weekdays and reduces during the weekends.
2. Demand varies with the time of the day, with increased demand(with outliers) after the 15th half-hourly interval.
3. Average Demand decreases in the summer and is high in the winters, probably because of the need of increased heating in the cold.

```{r}
##load against load48
gg2 <- ggplot(train, aes(load48, load))+
  geom_line()+
  xlab("One Day Lagged Electricity demand")+
  ylab("Current Electricity Demand (MW)")+
  theme(aspect.ratio=1/3)+
  ggtitle("Load v/s One-day lagged Load")

gg2
```
```{r}
ggplot(train, aes(load336, load))+
  geom_line()+
  xlab("One-week Lagged Electricity demand")+
  ylab("Current Electricity Demand (MW)")+
  theme(aspect.ratio=1/3)

```




```{r}
##load v/s smoothed temperature

ggplot(train, aes(temp95, load))+
  geom_line()+
  xlab("Temperature")+
  ylab(" Electricity Demand (MW)")+
  theme(aspect.ratio=1/3)

##above 20 degrees the electricity demand is less, less heating required

```



## Predictors we are thinking about using

1. Time of Year : toy 
2. Day of week  : dow
3. Lagged Load  : load48
4. Exp. Temperature : temp95
5. Time of Day : tod
6. Date
7. Year/month by weekday(Dow)? no
8. Time Count :Time Of Day but just scaled

Interactions:
1. load48 & temp95/temp
2. load48 & dow
3. tod & temp/temp95 ** cr/cs
4. toy & temp/ date & temp95
5. toy and tod cc


## Model Fitting


```{r}

response <- "load"
predictors1 <- c(
                 
                "s(toy, k= 50, bs='cc')", ##time of year
                
                "s(tod,bs='cr',k=48)", ##time of day
                
                "s(temp95, k= 20, bs = 'cs')", #smoothed temperature
                
                "s(temp,by=dow,k=20)",##temperature by day of week
                
                ##parametric terms
                
                "load48", ##lagged load 
                
                "load48:dow" ##interaction of lagged load and day of the week
                )

f1 <- as.formula(paste(response,paste(predictors1,collapse = "+"),sep = "~"))


mod1 <- bam(formula = f1, data = train, discrete=TRUE)
summary(mod1)

```
```{r}
gam.check(mod1)

```



```{r}



```
```{r}
gam.check(mod.lagged)
```



```{r}

predictors2 <- c( 
                  
                "s(toy, k= 50, bs = 'cs')", ##cumulative time count
                
                "s(temp95, k= 20, bs = 'cs')", #smoothed temperature
                
                "te(load48, tod, k = c(30, 20), bs = c('cr', 'cr'))", ##interaction with main effect load48 and time of day
                
                "ti(load48, temp, k = c(30, 30), bs = c('cr', 'cr'))",
                
                "ti(load48, month, k = c(30, 12), bs = c('cr', 'cr'))",
                
                "ti(temp95, toy, k = c(30, 20), bs = c('cr', 'cc'))", ##interaction between temperature and time of year
                
                "ti(temp95,by=dow,k = 20)",##temperature by day of week
                
                ##parametric terms
                
                "dow",
                 
                "load48:dow" ##parametric interaction of lagged load and day of the week
                
                )

f2 <- as.formula(paste(response,paste(predictors2,collapse = "+"),sep = "~"))


mod2 <- bam(formula = f2, data = train, discrete=TRUE)
summary(mod2)

```


```{r}
#par(mfrow=c(2,2))
gam.check(mod2)

```

```{r}
response <- "load"
predictor.lag <- c( "s(toy, k= 50, bs = 'cc')", ##time of year
                
                "s(temp95, k= 20, bs = 'cr')", #smoothed temperature
                
                "ti(lagtemp48, lagtemp96, k = c(20, 20), bs = c('cr', 'cr'))", 
                
                "s(load336, k = 30, bs = 'cr')", ##week before load
                
                "ti(temp95,by=dow,k=20)",##temperature by day of week
                
                "te(load48, tod, k = c(30, 20), bs = c('cr', 'cr'))", ##interaction with main effect load48 and time of day
                
                "ti(temp95, toy, k = c(30, 20), bs = c('cr', 'cc'))", ##interaction between temperature and time of year
                
                "ti(load48, temp, k = c(30, 20), bs = c('cr', 'cr'))",
                
                "ti(load48, month, k = c(30, 12), bs = c('cr', 'cr'))",
                
                ## parametric terms
                
                "dow",
                
                "load48:dow")
                
                

f.lag <- as.formula(paste(response,paste(predictor.lag,collapse = "+"),sep = "~"))


mod.lagged <- bam(formula = f.lag, data = train, discrete=TRUE)

summary(mod.lagged)


```

```{r}
gam.check(mod.lagged)
```

```{r}
r1 <- acf(resid(moddf), plot=FALSE)$acf[2]
```



```{r}

mod <- bam(formula = f.lag, data = train, rho = r1, discrete=TRUE)

summary(mod)

```

```{r}
gam.check(mod)
```


```{r}
predictor3 <- c( "s(toy, k= 50, bs = 'cc')", ##time of year
                 
                #"s(timeCount, k = 100, bs = 'cr') ",
                
                "s(temp95, k= 30, bs = 'cr')", #smoothed temperature
                
                "s(load336, k = 30, bs = 'cr')", ##week before load
                
                "ti(toy,tod, k= c(50,48), bs= c('cc','cr'))",
                
                "te(lagtemp48, lagtemp96, k = c(20, 20), bs = c('cr', 'cr'))", 

                "te(load48, tod, k = c(30, 48), bs = c('cr', 'cr'))", ##interaction with main effect load48 and time of day
                
                "ti(load48, temp, k = c(30, 20), bs = c('cr', 'cr'))",
                
                "ti(load48, month, k = c(30, 12), bs = c('cr', 'cr'))",
                
                "ti(load48, by = dow, k= 30)",
                
                "ti(temp95, toy, k = c(30, 20), bs = c('cr', 'cc'))", ##interaction between temperature and time of year
                
                "dow" )
                
                

f3 <- as.formula(paste(response,paste(predictor3,collapse = "+"),sep = "~"))


mod3 <- bam(formula = f3, data = train, discrete=TRUE)

summary(mod3)
```


```{r}
gam.check(mod3)
```


```{r}
plot(mod5, shade = TRUE, pages = 3, scale = 0)
```



```{r}

acf(resid(mod5), lag.max = 30, main = "ACF for model 3")
pacf(resid(mod5),lag.max = 30,main="PACF for model 3")
```
```{r}
visreg(mod4, xvar="temp",by="dow",data= train, method="REML")
```
## Model Performance for GAM model

```{r}
##predicted load : model 4
pred <- predict.gam(moddf,newdata=validation1,type="response")

##model performance
rmse(validation1$load,pred)
mape(validation1$load, pred)


AIC(moddfss)

```



```{r}
pred.actual <- data.frame(Date= validation$date, Hour = validation$tod , DayofWeek= validation$dow, Predicted = pred, Actual = validation$load)


```



```{r}
##actual v/s predicted load

ggplot(pred.actual,                                    
       aes(x = Predicted,
           y = Actual)) +
  geom_point() +
  xlim(0,65000) +
  ylim(0,70000) +
  geom_abline(intercept = 0,
              slope = 1,
              color = "red",
              size = 0.5)



```

```{r}
##actual and predicted forecast hourly

predict.mean <- pred.actual %>%
                group_by(Hour) %>%
                summarise_at(.vars = vars(Predicted, Actual),
                             .funs = c(mean="mean"))

predict.mean.long <- melt(predict.mean, id.vars="Hour")

ggplot(predict.mean.long,                                    
       aes(x = Hour, y = value,col= variable)) +
       geom_line(size = 1) +
       ylab("Actual and Predicted mean values") +
       ggtitle("Mean of Actual & Predicted values of Electricity Demand in Half-Hour Intervals")
  
  

```
```{r}

par(mfrow=c(1,2))
ggplot(pred.actual,                                    
       aes(x = Date, y = Actual),color = "black") + 
       geom_line() +
       ggtitle("Actual Electricity Demand in 2016")
       
ggplot(pred.actual,
       aes(x= Date, y= Predicted), color="red")+
       geom_line()+
       ggtitle("Predicted Electricity Demand in 2016")




```



## Random Forest model

```{r}

# set.seed(123)
# 
# rf.fit <- randomForest(load ~ toy + tod + dow + temp + load48, data=train, ntree = 30 , mtry = 2,
#                        keep.forest=TRUE, importance=TRUE)
# 
# rf.fit
# 
# ```
# ```{r}
# 
# 
# ##predicted values
# y_hat <- predict(rf.fit, validation)
# 
# 
# ##model performance of the random forest
# rmse(y_hat, validation$load)



```

